name: CI/CD Deploy Java WebApp to EC2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy WAR to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Upload and run deploy.sh on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo mkdir -p /opt
            sudo bash -c 'cat > /opt/deploy.sh' << 'EOF'
#!/bin/bash
set -e

echo "ðŸ”§ Installing dependencies..."
sudo apt update -y
sudo apt install -y openjdk-11-jdk wget unzip curl

echo "ðŸ“¦ Downloading and installing Tomcat 10.1.18..."
cd /opt
if [ -d "/opt/tomcat" ]; then
  sudo rm -rf /opt/tomcat
fi
wget https://archive.apache.org/dist/tomcat/tomcat-10/v10.1.18/bin/apache-tomcat-10.1.18.tar.gz
tar -xvzf apache-tomcat-10.1.18.tar.gz
mv apache-tomcat-10.1.18 tomcat
chmod +x /opt/tomcat/bin/*.sh

echo "ðŸ§¹ Cleaning previous deployment..."
cd /opt/tomcat/webapps
rm -rf ROOT ROOT.zip temp_root
mkdir -p temp_root

echo "ðŸ“¥ Downloading ROOT.zip from GitHub..."
wget -O ROOT.zip https://github.com/anil2743/clarify/releases/download/v1.0/ROOT.zip

echo "ðŸ“‚ Extracting WAR from ROOT.zip..."
unzip ROOT.zip -d temp_root
mkdir -p ROOT
cd ROOT
jar -xvf ../temp_root/ROOT.war

echo "â™»ï¸ Restarting Tomcat..."
/opt/tomcat/bin/shutdown.sh || true
sleep 3
/opt/tomcat/bin/startup.sh

echo "âœ… Deployment complete at $(date)"
EOF

            sudo chmod +x /opt/deploy.sh
            sudo /opt/deploy.sh
