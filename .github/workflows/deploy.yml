name: ~@ CI/CD Deploy Java WebApp to EC2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy WAR to EC2
    runs-on: ubuntu-latest

    steps:
      - name: ~M Checkout Code
        uses: actions/checkout@v3

      - name: M-& Deploy via SSH to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo " ~A Creating /opt..."
            sudo mkdir -p /opt

            echo " ~\\ Creating deploy.sh..."
            sudo tee /opt/deploy.sh > /dev/null << 'EOF'
            #!/bin/bash
            set -e

            echo " M-  Ensuring temp_root exists..."
            mkdir -p /opt/tomcat/webapps/temp_root

            echo " M-9 Cleaning previous deployment..."
            rm -rf /opt/tomcat/webapps/ROOT /opt/tomcat/webapps/ROOT.zip /opt/tomcat/webapps/temp_root

            echo " ~P Downloading ROOT.zip..."
            wget -O /opt/tomcat/webapps/ROOT.zip "https://github.com/anil2743/clarify/releases/download/v1.0/ROOT.zip"

            echo " M-& Extracting WAR..."
            unzip /opt/tomcat/webapps/ROOT.zip -d /opt/tomcat/webapps/temp_root

            mkdir -p /opt/tomcat/webapps/ROOT
            cd /opt/tomcat/webapps/ROOT
            jar -xvf /opt/tomcat/webapps/temp_root/ROOT.war

            echo " ~A Restarting Tomcat..."
            if [[ -x /opt/tomcat/bin/startup.sh && -x /opt/tomcat/bin/shutdown.sh ]]; then
                /opt/tomcat/bin/shutdown.sh || true
                sleep 3
                /opt/tomcat/bin/startup.sh
            else
                echo "❌ Tomcat not ready yet. Waiting..."
                for i in {1..6}; do
                  if [[ -x /opt/tomcat/bin/startup.sh && -x /opt/tomcat/bin/shutdown.sh ]]; then
                    echo "✅ Tomcat is now available. Restarting..."
                    /opt/tomcat/bin/shutdown.sh || true
                    sleep 3
                    /opt/tomcat/bin/startup.sh
                    break
                  else
                    echo "⏳ Still waiting... (${i}/6)"
                    sleep 10
                  fi
                done
                if [[ ! -x /opt/tomcat/bin/startup.sh ]]; then
                  echo "❌ ERROR: Tomcat scripts not found after waiting. Aborting."
                  exit 1
                fi
            fi

            echo "✅ Deployed at \$(date)" >> /opt/deploy.log
            EOF

            echo " ~@ Running deploy.sh..."
            sudo chmod +x /opt/deploy.sh
            sudo bash /opt/deploy.sh
