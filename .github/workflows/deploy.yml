name: ~@ CI/CD Deploy Java WebApp to EC2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy WAR to EC2
    runs-on: ubuntu-latest

    steps:
      - name: ~M Checkout Code
        uses: actions/checkout@v3

      - name: M-& Deploy via SSH to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo " ~A Creating /opt..."
            sudo mkdir -p /opt

            echo " ~\\ Creating deploy.sh..."
            sudo tee /opt/deploy.sh > /dev/null << 'EOF'
            #!/bin/bash
            set -e

            TOMCAT_DIR="/opt/tomcat"
            TOMCAT_VERSION="10.1.27"

            if [ ! -x "\$TOMCAT_DIR/bin/startup.sh" ]; then
              echo "âš™ï¸ Tomcat not found, installing..."
              cd /opt
              sudo apt update
              sudo apt install -y openjdk-17-jdk wget unzip
              sudo wget https://downloads.apache.org/tomcat/tomcat-10/v\$TOMCAT_VERSION/bin/apache-tomcat-\$TOMCAT_VERSION.tar.gz
              sudo tar -xzf apache-tomcat-\$TOMCAT_VERSION.tar.gz
              sudo mv apache-tomcat-\$TOMCAT_VERSION tomcat
              sudo chmod +x /opt/tomcat/bin/*.sh
              echo "âœ… Tomcat \$TOMCAT_VERSION installed."
            else
              echo "âœ… Tomcat already installed."
            fi

            echo "ðŸ“¦ Preparing deployment..."
            mkdir -p /opt/tomcat/webapps/temp_root
            rm -rf /opt/tomcat/webapps/ROOT /opt/tomcat/webapps/ROOT.zip /opt/tomcat/webapps/temp_root

            echo "ðŸ“¥ Downloading ROOT.zip..."
            wget -O /opt/tomcat/webapps/ROOT.zip "https://github.com/anil2743/clarify/releases/download/v1.0/ROOT.zip"

            echo "ðŸ“‚ Extracting WAR..."
            unzip /opt/tomcat/webapps/ROOT.zip -d /opt/tomcat/webapps/temp_root
            mkdir -p /opt/tomcat/webapps/ROOT
            cd /opt/tomcat/webapps/ROOT
            jar -xvf /opt/tomcat/webapps/temp_root/ROOT.war

            echo "ðŸ” Restarting Tomcat..."
            /opt/tomcat/bin/shutdown.sh || true
            sleep 3
            /opt/tomcat/bin/startup.sh

            echo "âœ… Deployed at \$(date)" >> /opt/deploy.log
            EOF

            echo " ~@ Running deploy.sh..."
            sudo chmod +x /opt/deploy.sh
            sudo bash /opt/deploy.sh
