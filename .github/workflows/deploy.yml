name: CI/CD Deploy Java WebApp to EC2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Build and Deploy WAR to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build WAR using Maven
        run: mvn clean package -DskipTests

      - name: Create ROOT.zip
        run: |
          mkdir deploy
          cp target/*.war deploy/ROOT.war
          cd deploy
          zip ROOT.zip ROOT.war

      - name: Upload ROOT.zip to EC2
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "deploy/ROOT.zip"
          target: "/home/${{ secrets.EC2_USER }}/"

      - name: Verify ROOT.zip exists on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üîç Verifying upload..."
            if [ -f "/home/${USER:-ubuntu}/ROOT.zip" ]; then
              echo "‚úÖ ROOT.zip exists on EC2"
            else
              echo "‚ùå ERROR: ROOT.zip missing on EC2"
              exit 1
            fi

      - name: SSH into EC2 and Deploy WAR
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ Starting Deployment on EC2..."

            # Move to /opt
            sudo mv /home/${USER:-ubuntu}/ROOT.zip /opt/ROOT.zip

            # Install dependencies
            sudo apt update -y
            sudo apt install -y openjdk-11-jdk wget unzip curl

            # Setup Tomcat if missing
            if [ ! -d /opt/tomcat ]; then
              echo "‚¨áÔ∏è Installing Tomcat..."
              cd /opt
              wget https://archive.apache.org/dist/tomcat/tomcat-10/v10.1.18/bin/apache-tomcat-10.1.18.tar.gz
              tar -xzf apache-tomcat-10.1.18.tar.gz
              mv apache-tomcat-10.1.18 tomcat
              chmod +x /opt/tomcat/bin/*.sh
            fi

            # Deploy WAR
            echo "üì¶ Deploying WAR..."
            cd /opt/tomcat/webapps
            sudo rm -rf ROOT temp_root
            sudo mkdir temp_root
            sudo unzip /opt/ROOT.zip -d temp_root
            sudo mkdir ROOT
            cd ROOT
            sudo jar -xvf ../temp_root/ROOT.war

            echo "‚ôªÔ∏è Restarting Tomcat..."
            sudo /opt/tomcat/bin/shutdown.sh || true
            sleep 3
            sudo /opt/tomcat/bin/startup.sh

            echo "‚úÖ Deployment Finished at $(date)"
